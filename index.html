<script>
  // Page protection: redirect to login if user is not logged in
  if (localStorage.getItem("loggedIn") !== "yes") {
    window.location.href = "login.html";
  }
</script>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raindrop Taxi â€“ Book Ride</title>

<!-- Uber Font -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

<!-- Leaflet Maps (FREE, NO API KEY) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<!-- Routing Machine (FREE) -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"/>
<script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>


<style>
body {
    margin: 0;
    background: #f2f2f2;
    font-family: Inter, sans-serif;
}

header {
    background: #000;
    color: #fff;
    padding: 15px 25px;
    display: flex;
    align-items: center;
    gap: 15px;
}

header img {
    height: 45px;
}

.container {
    max-width: 1200px;
    margin: auto;
    display: flex;
    gap: 20px;
    padding: 25px;
}

.card, .side-card {
    background: #fff;
    padding: 20px;
    border-radius: 14px;
    box-shadow: 0 4px 14px rgba(0,0,0,0.1);
}

.card { flex: 1; }
.side-card { width: 380px; }

input, select {
    width: 100%;
    padding: 12px;
    margin-top: 10px;
    border-radius: 10px;
    border: 1px solid #ccc;
}

button {
    width: 100%;
    padding: 14px;
    margin-top: 15px;
    background: #000;
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 16px;
    cursor: pointer;
    font-weight: 600;
}

#map {
    width: 100%;
    height: 250px;
    border-radius: 10px;
    background: #ddd;
}

.driver-card {
    padding: 10px;
    border: 1px solid #ccc;
    border-radius: 12px;
    margin-bottom: 10px;
    cursor: pointer;
}
</style>

</head>
<body>

<header>
    <img src="assets/logo.png" alt="Raindrop Taxi Logo">
    <h1>Raindrop Taxi</h1>
</header>

<div class="container">

    <!-- LEFT SIDE -->
    <div class="card">
        <h2>Book a Ride</h2>

        <label>Pickup location</label>
        <input id="pickup" placeholder="Enter pickup">

        <label>Drop location</label>
        <input id="drop" placeholder="Enter drop">

        <label>Date & time</label>
        <input type="datetime-local" id="datetime">

        <label>Vehicle</label>
        <select id="vehicle">
            <option>Sedan</option>
            <option>SUV</option>
            <option>Mini</option>
        </select>

        <button onclick="showRoute()">Show on Map</button>
        <button onclick="bookWhatsApp()">Book via WhatsApp</button>
        <button onclick="payUPI()">Pay via UPI</button>
    </div>

    <!-- RIGHT SIDE -->
    <div class="side-card">

        <h3>Driver</h3>
        <img src="assets/driver.jpg" style="width:100%;border-radius:10px" alt="Driver">

        <h3>Vehicle</h3>
        <img src="assets/car.jpg" style="width:100%;border-radius:10px" alt="Car">

        <h3>Live Route Map</h3>
        <div id="map" aria-label="map"></div>

        <h3>OTP</h3>
        <p id="otpBox">OTP will appear here</p>

    </div>
</div>

<script>
/* Initialize Leaflet map */
let map = L.map('map').setView([11.75, 79.76], 10);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
}).addTo(map);

let routingControl;

/* Show route inside the map using OSM Nominatim + Leaflet Routing Machine */
function showRoute() {
    let p = document.getElementById("pickup").value.trim();
    let d = document.getElementById("drop").value.trim();

    if (!p || !d) {
        alert("Enter pickup & drop!");
        return;
    }

    // Simple geocode via Nominatim (no API key)
    Promise.all([
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(p)}`).then(r => r.json()),
        fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(d)}`).then(r => r.json())
    ]).then(([start, end]) => {
        if (!start.length || !end.length) {
            alert('Could not find one of the locations. Try a different query (city, landmark or full address).');
            return;
        }

        const pCoords = [parseFloat(start[0].lat), parseFloat(start[0].lon)];
        const dCoords = [parseFloat(end[0].lat), parseFloat(end[0].lon)];

        if (routingControl) {
            map.removeControl(routingControl);
        }

        routingControl = L.Routing.control({
            waypoints: [
                L.latLng(pCoords[0], pCoords[1]),
                L.latLng(dCoords[0], dCoords[1])
            ],
            routeWhileDragging: false,
            show: false,
            addWaypoints: false
        }).addTo(map);

        // Fit map bounds to route when ready
        routingControl.on('routesfound', function(e) {
            const route = e.routes[0];
            const bounds = route.bounds;
            map.fitBounds(bounds, { padding: [40, 40] });
        });
    }).catch(err => {
        console.error(err);
        alert('Failed to calculate route. Try again.');
    });
}

/* WhatsApp booking (pre-filled message) */
function bookWhatsApp() {
    const p = document.getElementById('pickup').value.trim();
    const d = document.getElementById('drop').value.trim();
    const t = document.getElementById('datetime').value;
    const v = document.getElementById('vehicle').value;

    if (!p || !d) {
        alert('Please enter pickup & drop address!');
        return;
    }

    const otp = Math.floor(1000 + Math.random() * 9000);
    document.getElementById('otpBox').innerText = 'Ride OTP: ' + otp;

    const message = [
        '*Raindrop Taxi Booking*',
        'Pickup: ' + p,
        'Drop: ' + d,
        'Time: ' + (t || 'ASAP'),
        'Vehicle: ' + v,
        'OTP: ' + otp
    ].join('%0A');

    // WhatsApp number (without + or spaces). Country code 91 is used.
    const phone = '919486576643';
    window.open(`https://wa.me/${phone}?text=${message}`, '_blank');
}

/* UPI payment deep link */
function payUPI() {
    const upi = 'prasanthvjm890-1@okhdfcbank';
    // Using UPI URI scheme; on desktop this may not do anything, on mobile it opens the UPI app.
    window.location.href = `upi://pay?pa=${encodeURIComponent(upi)}&pn=${encodeURIComponent('Raindrop Taxi')}&cu=INR`;
}
</script>

</body>
</html>
